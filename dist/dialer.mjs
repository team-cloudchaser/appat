"use strict";let f=self.Deno?.createHttpClient({allowHost:!0}),a=class{report=!0;instanceId;#a=!0;#i=!0;#c=2;#o;#t;#r;#n;#e;#s;constructor(e,s){if(!Request.prototype.hasOwnProperty("body"))throw this.#i=!1,new Error("Fetch requests do not support streamable bodies");if(typeof self?.WebSocketStream!="function")throw this.#a=!1,new Error("WebSocket does not support streaming");typeof self?.Deno<"u"&&(this.#c=0),this.#t=s,this.#o=e}async start(){let e=this;if(e.#e)switch(e.#e.readyState){case WebSocket.CLOSING:case WebSocket.CLOSED:throw new Error("Attempted reconnection for an active dialer")}e.instanceId=self.crypto?.randomUUID(),e.#r=`${e.#o}/ws/${e.instanceId}`,e.#n=e.#r.replace("http","ws"),e.#e=new WebSocket(`${e.#r}/ctrl?token=${e.#t}`),e.#e.addEventListener("error",s=>{console.warn("Control socket has errored out:",s.error)}),e.#e.addEventListener("close",s=>{e.#s.abort(),console.warn("Control socket closed.")}),e.#e.addEventListener("opened",s=>{console.warn("Control socket is now ready."),e.#s=new AbortController}),e.#e.addEventListener("message",async s=>{let t=JSON.parse(s.data);switch(console.debug(t),t.m){case"PING":{console.debug("Pong!");break}case"WS":break;case"WT":break;case"GET":{let o={method:t.m,signal:e.#s};if(t.hasOwnProperty("e")){if(t.e.hasOwnProperty("r")){o.referrerPolicy="unsafe-url";let r=new URL(t.e.r);o.referrer=t.e.r.replace(`${r.protocol}//${r.hostname}`)}t.e.hasOwnProperty("h")&&(o.headers=t.e.h)}try{let r=await fetch(t.u,o);if(e.report){let n={c:t.c,s:r.status,t:r.statusText,h:{}};for(let[c,l]of r.headers.entries())n.h[c]=l;e.#e.send(JSON.stringify(n))}new WebSocketStream(`${e.#n}/${t.c}?token=${e.#t}`).opened.then(async({writable:n})=>{await r.body.pipeTo(n)})}catch(r){if(console.warn(r),e.report){let i={c:t.c,s:0,t:r.name,e:`${r.message}
${r.stack}`};e.#e.send(JSON.stringify(i))}}break}default:}})}};export{a as default};
