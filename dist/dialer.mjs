"use strict";let h=self.Deno?.createHttpClient({allowHost:!0}),c=class{report=!0;instanceId;#c=!0;#i=!0;#o=2;#a;#t;#r;#n;#e;#s;constructor(e,s){if(!Request.prototype.hasOwnProperty("body"))throw this.#i=!1,new Error("Fetch requests do not support streamable bodies");if(typeof self?.WebSocketStream!="function")throw this.#c=!1,new Error("WebSocket does not support streaming");typeof self?.Deno<"u"&&(this.#o=0),this.#t=s,this.#a=e}async start(){let e=this;if(e.#e)switch(e.#e.readyState){case WebSocket.CLOSING:case WebSocket.CLOSED:throw new Error("Attempted reconnection for an active dialer")}e.instanceId=self.crypto?.randomUUID(),e.#r=`${e.#a}/ws/${e.instanceId}`,e.#n=e.#r.replace("http","ws"),e.#e=new WebSocket(`${e.#r}/ctrl?token=${e.#t}`),e.#e.addEventListener("error",s=>{console.warn("Control socket has errored out:",s.error)}),e.#e.addEventListener("close",s=>{e.#s.abort(),console.warn("Control socket closed.")}),e.#e.addEventListener("opened",s=>{console.warn("Control socket is now ready."),e.#s=new AbortController}),e.#e.addEventListener("message",async s=>{let t=JSON.parse(s.data);switch(console.debug(t),t.m){case"PING":{console.debug("Pong!");break}case"WS":break;case"WT":break;case"HEAD":case"GET":case"POST":case"PUT":case"DELETE":case"OPTIONS":case"PATCH":{let o={method:t.m,signal:e.#s};if(t.hasOwnProperty("e")){if(t.e.hasOwnProperty("r")){o.referrerPolicy="unsafe-url";let r=new URL(t.e.r);o.referrer=t.e.r.replace(`${r.protocol}//${r.hostname}`)}t.e.hasOwnProperty("h")&&(o.headers=t.e.h)}try{let a=await new WebSocketStream(`${e.#n}/${t.c}?token=${e.#t}`).opened;switch(t.m){case"POST":case"PUT":case"DELETE":case"OPTIONS":case"PATCH":{o.body=a.readable,o.duplex=e.#o>0?"half":"full";break}}let n=await fetch(t.u,o);if(e.report){let i={c:t.c,s:n.status,t:n.statusText,h:{}};for(let[l,d]of n.headers.entries())i.h[l]=d;e.#e.send(JSON.stringify(i))}t.m==="HEAD"?a.close():await n.body.pipeTo(a.writable)}catch(r){if(console.warn(r),e.report){let a={c:t.c,s:0,t:r.name,e:`${r.message}
${r.stack}`};e.#e.send(JSON.stringify(a))}}break}default:console.warn(`Unsupported method: ${t.m}`)}})}};export{c as default};
