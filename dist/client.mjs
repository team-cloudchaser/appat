"use strict";let w=self.Deno?.createHttpClient({allowHost:!0}),n=class{report=!0;instanceId;#a=!0;#i=!0;#l=2;#o;#t;#r;#n;#e;#s;constructor(e,s){if(!Request.prototype.hasOwnProperty("body"))throw this.#i=!1,new Error("Fetch requests do not support streamable bodies");if(typeof self?.WebSocketStream!="function")throw this.#a=!1,new Error("WebSocket does not support streaming");typeof self?.Deno<"u"&&(this.#l=0),this.#t=s,this.#o=e}async start(){let e=this;if(e.#e)switch(e.#e.readyState){case WebSocket.CLOSING:case WebSocket.CLOSED:throw new Error("Attempted reconnection for an active dialer")}e.instanceId=self.crypto?.randomUUID(),e.#r=`${e.#o}/ws/${e.instanceId}`,e.#n=e.#r.replace("http","ws"),e.#e=new WebSocket(`${e.#r}/ctrl?token=${e.#t}`),e.#e.addEventListener("error",s=>{console.warn("Control socket has errored out:",s.error)}),e.#e.addEventListener("close",s=>{e.#s.abort(),console.warn("Control socket closed.")}),e.#e.addEventListener("opened",s=>{console.warn("Control socket is now ready."),e.#s=new AbortController}),e.#e.addEventListener("message",async s=>{let t=JSON.parse(s.data);switch(console.debug(t),t.m){case"PING":{console.debug("Pong!");break}case"WS":break;case"WT":break;case"GET":{let i={method:t.m,signal:e.#s};if(t.hasOwnProperty("e")){if(t.e.hasOwnProperty("r")){i.referrerPolicy="unsafe-url";let r=new URL(t.e.r);i.referrer=t.e.r.replace(`${r.protocol}//${r.hostname}`)}t.e.hasOwnProperty("h")&&(i.headers=t.e.h)}try{let r=await fetch(t.u,i);if(e.report){let l={c:t.c,s:r.status,t:r.statusText,h:{}};for(let[f,d]of r.headers.entries())l.h[f]=d;e.#e.send(JSON.stringify(l))}new WebSocketStream(`${e.#n}/${t.c}?token=${e.#t}`).opened.then(async({writable:l})=>{await r.body.pipeTo(l)})}catch(r){if(console.warn(r),e.report){let c={c:t.c,s:0,t:r.name,e:`${r.message}
${r.stack}`};e.#e.send(JSON.stringify(c))}}break}default:}})}};let a;self.location?.href?a=`${location.protocol}//${location.host}`:self.Deno?.args[0]?.length>0?a=`http://${self.Deno.args[0]}`:a="http://127.0.0.1:5779";console.debug(`Received dialer prefix: ${a}`);let h="__CSRF_TOKEN__",o="__CSRF_TOKEN__";o===h&&(self.location?.search?.indexOf("?token=")===0?o=self.location.search.substring(7):self.Deno?.args[1]?.length>0?o=self.Deno.args[1]:o="00000000-0000-0000-0000-000000000000");console.debug(`Received CSRF token: ${o}`);let p=new n(a,o);p.start();
